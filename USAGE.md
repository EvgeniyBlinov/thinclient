You need [git](https://git-scm.com/), [Virtualbox](https://www.virtualbox.org) and [Vagrant](https://www.vagrantup.com/). You can use this software on any system: Windows, Linux or MacOS X.

## Prepare the workplace

Clone this repository:
```
git clone https://github.com/selivan/thinclient.git
cd thinclient
```

Create machine that will be used as template for our image.\
`vagrant up template`

Create machine that will work as PXE server for testing. Also it is used to provision configuration to template machine with [Ansible](http://docs.ansible.com/ansible/latest/index.html).\
`vagrant up server`

Reload template to boot with new kernel.\
`vagrant reload template`

## Customize thin client image

Log into template machine.\
`vagrant ssh template`

Here you can customize your thin client image: install packages, configs, ...

Do not:
* Remove package virtualbox-guest-utils
* Remove openssh-server
* Change type and settings of first network interface

If you do one of this actions, then you should do further work inside template virtual machine manually, without vagrant.

After all work is done, build images inside template machine:

```bash
cd /vagrant
./build.sh all
```

You will get this artifacts in `/vagrant/build` directory:
* `vmlinuz` - linux kernel
* `initrd.img` - initial ram disk
* `rootfs.squashfs` - root FS image
* `home.tar.gz` - compressed home directory for user ubuntu
* `pxelinux.0`, `ldlinux.c32` - [pxelinux](http://www.syslinux.org/wiki/index.php?title=PXELINUX) network bootloader files
* `pxelinux.cfg/default` - configuration for pxelinux. Boot parameters are set here.

Notice: ssh keys for ubuntu user, generated by Vagrant, are not included in home directory for security reasons.

## Test result

Create machine to test created images. It is configured to boot from server machine over network.
`vagrant up test`

Command will end up with error, it's OK: first interface is used for network boot, vagrant can not connect to it.

*Remove storage SCSI controller from test machine in Virtualbox. With my versions of linux kernel and virtualbox it sometimes makes kernel crash. Some rare bug, may not affect you.*

Server machine is cofigured as DHCP and TFTP server(dnsmasq), and HTTP server(nginx). HTTP is used to transfer huge rootfs image and home directory archive. In test environment you can transfer huge files with TFTP. But in real networks it is not very suitable for this task.

Start test machine. If everything is OK, it should boot with your image over network from server machine.
