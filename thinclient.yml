- hosts: server
  become: yes
  tasks:
    - name: read config variables
      include_vars: vars.yml
      # /vagrant is used because ansible_local playbook runs inside virtual host
    # - name: generate variables for shell scripts
    #   local_action: template src=/vagrant/vars.sh.j2 dest=/vagrant/vars.sh
    - name: install apt sources.list
      template: src=common/apt/sources.list dest=/etc/apt/sources.list mode=0644
      register: apt_sources_list
    - name: update apt cache
      apt: update_cache=yes
      when: apt_sources_list|changed
    - name: install required packages
      apt: name={{ item }} state=latest
      with_items:
        - dnsmasq
        - nginx-light
        - pxelinux
        # this package has modules necessary for pxelinux to boot
        - syslinux-common
        - rsync
    - name: install some packages for convenient work
      apt: name={{ item }} state=latest
      with_items:
        - bash-completion
        - tmux
        - mc
        - vim-tiny
    - name: install dnsmasq configs
      template: src=server/dnsmasq/dnsmasq.conf dest=/etc/dnsmasq.conf mode=0644
      notify: restart dnsmasq
    - name: create symlinks for pxelinux loader
      file: path={{ item.path }} state=link src={{ item.src }}
      with_items:
        - { path: '/vagrant/build/pxelinux.0', src: '/usr/lib/PXELINUX/pxelinux.0' }
        - { path: '/vagrant/build/ldlinux.c32', src: '/usr/lib/syslinux/modules/bios/ldlinux.c32' }
    - name: install nginx default site config
      template: src=server/nginx/sites-available/default dest=/etc/nginx/sites-available/default mode=0644
      notify: restart nginx
    - name: enable nginx default site
      file: path=/etc/nginx/sites-enabled/default state=link src=/etc/nginx/sites-available/default
      notify: restart nginx
    - name: create pxelinux.cfg directory
      file: path=/vagrant/build/pxelinux.cfg state=directory mode=0755
    - name: copy pxelinux default configs
      copy: src=server/pxelinux.cfg/default dest=/vagrant/build/pxelinux.cfg/default mode=0644
  handlers:
    - name: restart dnsmasq
      service: name=dnsmasq state=restarted
    - name: restart nginx
      service: name=nginx state=restarted

- hosts: template
  become: yes
  tasks:
  - name: read config variables
    include_vars: vars.yml
  - name: install apt sources.list
    template: src=common/apt/sources.list dest=/etc/apt/sources.list mode=0644
    register: apt_sources_list
  - name: update apt cache
    apt: update_cache=yes
    when: apt_sources_list|changed
  - name: remove unnecessary packages
    apt: name={{ item }} state=absent
    with_items:
      - [ accountsservice, apport, apport-symptoms, bcache-tools, byobu, cloud-init, cloud-guest-utils, cloud-initramfs-copymods, cloud-initramfs-dyn-netconf, cryptsetup, cryptsetup-bin, command-not-found, command-not-found-data, dosfstools, info, lvm2, mdadm, lxc-common, lxcfs, lxd, lxd-client, mlocate, overlayroot, rename, screen, tcpd, snapd, sosreport, ssh-import-id, ubuntu-core-launcher, ureadahead, ufw, unattended-upgrades, update-notifier-common, zerofree ]
  - name: install required packages
    apt: name={{ item }} state=latest
    with_items:
      - squashfs-tools
      - initramfs-tools
      - cpio
      - aufs-tools
  - name: install general linux kernel packages
    apt: pkg={{ item }} state=latest
    with_items:
      - linux-image-generic-hwe-16.04-edge
      - linux-firmware
  - name: remove virtual linux kernel packages and headers
    apt: pkg={{ item }} state=absent
    with_items:
      - linux-image-virtual
      - linux-headers-virtual
      - linux-headers-generic
  - name: install initramfs hook script and config
    copy: src=template/{{ item }} dest=/etc/{{ item }} mode=0755
    with_items:
      - initramfs-tools/hooks/zz_custom
      - initramfs-tools/scripts/ram
      - initramfs-tools/initramfs.conf
